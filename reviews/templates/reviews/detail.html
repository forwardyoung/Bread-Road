{% extends 'base.html' %}
{% load django_bootstrap5 %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
<link rel="icon" href="https://templates.pingendo.com/assets/Pingendo_favicon.ico">

{% block content %}
<div class='wraper m-auto' style='max-width:720px; width:auto; box-shadow:0 0 20px rgb(0 0 0 / 5%);'>
<div class='container py-3' style='background-color:rgb(252, 248, 237, 0.7);'>
<div>
{% comment %} 빵집 이름 {% endcomment %}
<h3 class='fw-bolder'><a href="{% url 'bakeries:shop_home' review.shop_id %}" style='text-decoration:none; color:black'>🍞{{ review.shop_name }}</a></h3>
</div>
<div class='header d-flex'>
  <div class='profile d-flex mt-2'>
  {% comment %} 리뷰 작성자 이름(클릭하면 리뷰 프로필 페이지로 이동) {% endcomment %}
  <span class='username'><a class='text-decoration-none fw-bolder' style='color:black' href="{% url 'accounts:detail' review.user.pk %}">{{ review.user.image }}{{ review.user.username }}</a></span>
  {% comment %} 리뷰 작성 개수 {% endcomment %}
  <span>&nbsp;리뷰 {{ user.review_set.count }}개</span>
  </div>
  
  {% comment %} 팔로우 버튼 {% endcomment %}
  {% if request.user != user %}
    <a style="text-decoration:none; color:blue;" class="follow-implement" href="{% url 'accounts:follow' user.pk %}">
        {% if request.user in user.followers.all %}
        {% comment %} <i class="bi bi-backspace-fill"> Unfollow!</i> {% endcomment %}
        <button class='btn btn-warning btn-rounded' style='border-radius:20px; margin-left:auto'>
        <span class='label fw-bolder'>팔로우 취소</span>
        </button> 
        {% else %}
        {% comment %} <button class='btn btn-warning btn-rounded' style='border-radius:20px; margin-left:auto'>
        <span class='label fw-bolder'>팔로우</span>
        </button> {% endcomment %}
        <i class="bi bi-check-square-fill"> Follow!</i>
        {% endif %}
    </a>
  {% endif %}
  <button class='btn btn-warning btn-rounded' style='border-radius:20px; margin-left:auto'>
  <span class='label fw-bolder'>팔로우</span>
  </button>
</div>

{% comment %} 최근 방문일 {% endcomment %}
<p class='mt-3 fw-bolder'>{{ review.visited_at.isoformat }}</p>
<div class='justify-content-center'>
{% if review.image %}
  <img src='{{ review.image.url }}' alt='{{ review.image }}' width="400" height="300" style='border-radius:4px'>
  <p class="me-3-5 mt-3">{{ review.content }}</p>
{% endif %}
</div>
<span>
{% comment %} 좋아요 버튼 {% endcomment %}
    {% if request.user.is_authenticated %}
        <a class="like-heart text-decoration-none" href="{% url 'reviews:like' review.pk %}">
        {% comment %} 하트 아이콘 옆에 _ 표시 제거 : text-decoration-none {% endcomment %}
        {% if request.user in review.like_users.all %}
        <i class="bi bi-heart-fill"></i>
        {% else %}
        <i class="bi bi-heart"></i>
        {% endif %}</a>{{ review.like_users.count }}
</span>
    {% endif %}

{% if request.user == review.user %}
<div class='mt-2 d-flex'>
{% comment %} 요청한 user가 리뷰를 작성한 user일 경우에 수정 및 삭제{% endcomment %}
  <p>
    <button type="button" class="btn btn-warning me-2" >
      <a href="{% url 'reviews:update' review.pk %}" style='text-decoration:none; color:white' class='fw-bolder'>수정하기</a>
    </button>
  </p>
  <p>
    <form action="{% url 'reviews:delete' review.pk %}" method="POST">
      {% csrf_token %}
      <input type="submit" class="btn btn-danger fw-bolder" value="삭제하기">
    </form>
  </p>
</div>
{% endif %}

{% comment %} 댓글 {% endcomment %}
<h4 class="my-3 fw-bolder">댓글</h4>
{% if request.user.is_authenticated %}
<form action="{% url 'reviews:comment_create' review.pk %}" method="POST">
  {% csrf_token %}
  {% bootstrap_form comment_form layout='inline'%}
  <br>
  {% bootstrap_button style='float:right; color:white' button_type="submit" button_class="btn btn-warning fw-bolder" content="OK" %}
</form>
{% endif %}

{% for comment in comments %}
<div class='mt-3'>
  <div class="align-items-center">
    <a class="text-decoration-none fw-bolder" style='color:gray' href="{% url 'accounts:detail' comment.user.pk %}">{{ comment.user.username }}</a>&nbsp;&nbsp;{{ comment.content }}
  </div>
  {% comment %} 댓글을 작성한 user가 리뷰를 쓴 유저인 경우 {% endcomment %}
  {% if review.user == comment.user %} 
    <form action="{% url 'reviews:comment_delete' review.pk comment.pk %}" method="POST" class="my-0">
      {% csrf_token %}
      <input type="submit" class="btn btn-outline-danger mt-2" value="삭제">
    </form>
  {% endif %}
{% empty %}
  <p>댓글을 입력해주세요</p>
{% endfor %}
</div>
</div>
</div>  
{% endblock %}